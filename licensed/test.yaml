---
- config:
    - testset: "licensed api tests"

- test:
    - group: "Uses"
    - name: "Basic smoketest for /uses"
    - url: "/uses"

- test:
    - group: "Uses"
    - name: "Create a use"
    - url: "/uses"
    - method: "POST"
    - body: '{ "action" : "http://www.w3.org/ns/odrl/2/distribute", "constraints" : [ { "name": "http://www.w3.org/ns/odrl/2/spatial", "operator": "http://w3.org/ns/odrl/2/vocab/eq", "rightoperand": "http://cvx.iptc.org/iso3166-1a3/DEU" } ] }'
    - headers: {'Content-Type': 'application/json'}
    - extract_binds:
        - 'id': {'jsonpath_mini': 'id'}

- test:
    - group: "Uses"
    - name: "Get use you just created and validate it"
    - url: {'template': "/uses/$id"}
    - validators:
        - compare: {jsonpath_mini: 'id', comparator: 'str_eq', expected: {template: '$id'}}
        - compare: {jsonpath_mini: 'action', comparator: 'eq', expected: 'http://www.w3.org/ns/odrl/2/distribute'}

- test:
    - group: "Uses"
    - name: "Update the use you just created"
    - url: {'template': "/uses/$id"}
    - method: "PUT"
    - body: '{ "action" : "http://www.w3.org/ns/odrl/2/display", "constraints" : [ { "name": "http://www.w3.org/ns/odrl/2/spatial", "operator": "http://w3.org/ns/odrl/2/vocab/eq", "rightoperand": "http://cvx.iptc.org/iso3166-1a3/DEU" } ] }'
    - headers: {'Content-Type': 'application/json'}

- test:
    - group: "Uses"
    - name: "Get use you just created and validate it"
    - url: {'template': "/uses/$id"}
    - validators:
        - compare: {jsonpath_mini: 'id', comparator: 'str_eq', expected: {template: '$id'}}
        - compare: {jsonpath_mini: 'action', comparator: 'str_eq', expected: "http://www.w3.org/ns/odrl/2/display"}

- test:
    - group: "Uses"
    - name: "Delete the use you just created"
    - url: {'template': "/uses/$id"}
    - method: "DELETE"

- test:
    - group: "Policies"
    - name: "Basic smoketest for /policies"
    - url: "/policies"

- test:
    - group: "Policies"
    - name: "Create a policy"
    - url: "/policies"
    - method: "POST"
    - body: '{ "policytype": "http://www.w3.org/ns/odrl/2/Set", "policyid": "http://example.com/policy:0099", "permissions": [{ "target": "http://example.com/asset:9898", "action": "http://www.w3.org/ns/odrl/2/reproduce" }], "prohibitions": [{ "target": "http://example.com/asset:9898", "action": "http://www.w3.org/ns/odrl/2/modify" }] }'
    - headers: {'Content-Type': 'application/json'}
    - extract_binds:
        - 'id': {'jsonpath_mini': 'id'}

- test:
    - group: "Policies"
    - name: "Get policy you just created and validate it"
    - url: {'template': "/policies/$id"}
    - validators:
        - compare: {jsonpath_mini: 'id', comparator: 'str_eq', expected: {template: '$id'}}
        - compare: {jsonpath_mini: 'policytype', comparator: 'eq', expected: 'http://www.w3.org/ns/odrl/2/Set'}
        - json_schema: {schema: {file: 'ODRL21.json'}}
